

let _express = require('express');
const dbConfig = require('./config');
const connection = require('./connection');
const query = require('./DbOperation');


var bodyParser = require("body-parser");
let cors = require('cors');
var fs = require('fs');
const { json } = require('body-parser');
let _application = _express();
let _router = _express.Router();
const _port = 3000;
_application.use(_express.static("public"));
_application.use(bodyParser.json());       // to support JSON-encoded bodies
_application.use(bodyParser.urlencoded({     // to support URL-encoded bodies
    extended: true
}));

var questionID = 0;


_application.use(cors())
_router.get('/', (_request, _response) => _response
    .status(200)
    .send({ response: { home: true, content: "This is Home Page of the application." } }));

_router.get('/getAll()', async (_request, _response) => {


    /*  var result;
     
     result = database.getAll();
     console.log(result); */

    const conn = await connection(dbConfig).catch(e => { })
    const results = await query(conn, 'SELECT * FROM questions').catch(console.log);

    _response.setHeader('Content-Type', 'application/json');
    _response
        .status(200)
        .send({ results });

});

_application.use("/api", _router);

let _server = _application.listen(_port, () => {
    console.log("Application started and listening on port: ", _port);
});




_router.post("/reply", async function (req, res) {
    // get data from forms and add to the table called user..

    var aid = req.body.aid;
    var reply_username = req.body.reply_username;
    var question_reply = req.body.question_reply;
    const conn = await connection(dbConfig).catch(e => { })
    let Question = await query(conn, 'insert into reply (aid,reply,username) values(' + aid + ',"' + question_reply + '","' + reply_username + '")').catch(console.log);

    res.redirect('back');
    /*  res.set('Content-Type', 'text/html');
     res.status(200)
         .send('<h2>Test String</h2>'); */

});
_router.post("/answer", async function (req, res) {
    // get data from forms and add to the table called user..

    console.log("inside answer ");
    let qid = req.body.qid;
    let answer_username = req.body.answer_username;
    let answer = req.body.answer;
    const conn = await connection(dbConfig).catch(e => { })
    let Question = await query(conn, 'insert into answers (qid,answers,username) values(' + qid + ',"' + answer + '","' + answer_username + '")').catch(console.log);

    res.redirect('back');
    /*  res.set('Content-Type', 'text/html');
     res.status(200)
         .send('<h2>Test String</h2>'); */

});

_router.post("/newquestion", async function (req, res) {


    var username = req.body.username;
    let email = req.body.email;
    let title = req.body.title;
    let category = req.body.category;
    let question = req.body.question;



    const conn = await connection(dbConfig).catch(e => { })
    let Question = await query(conn, 'insert into questions(title,username,email,question,category) values("' + title + '","' + username + '","' + email + '","' + question + '","' + category + '")').catch(console.log);

    res.redirect('back');

    //database.insertData(3, title, username, email, question, category);
    res.set('Content-Type', 'text/html');
    res.status(200)
        // .redirect('index.html');
        .send('<h2>Test String</h2>');
    // res.redirect(index.html);

});

_router.post("/set", function (req, res) {
    // get data from forms and add to the table called user..

    var tempID = req.body.questionID;
    questionID = tempID;


    res.status(200)
        .send('done');
});



_router.get("/loadPost", async function (req, res) {

    var reply_data = [];
    const conn = await connection(dbConfig).catch(e => { })
    console.log("control in load " + questionID);
    let Question = await query(conn, 'SELECT qid,question,username from questions where qid=' + questionID).catch(console.log);
    let answers = await query(conn, 'SELECT aid,answers,username from answers where qid=' + questionID).catch(console.log);

    answers = JSON.stringify(answers);
    answers = JSON.parse(answers);
    //console.log(results[0]["aid"]);

    for (let i = 0; i < answers.length; i++) {
        let replyRow = await query(conn, 'SELECT rid,reply,username from reply where aid=' + answers[i]["aid"]).catch(console.log);
        replyRow = JSON.stringify(replyRow);
        replyRow = JSON.parse(replyRow);


        reply_data.push(replyRow);
    }

    Question = JSON.stringify(Question);
    Question = JSON.parse(Question);

    //console.log("final data", final_data);
    //console.log("question", Question);
    res.set('Content-Type', 'application/json');

    res.status(200)
        .send({ Question, answers, reply_data });

});
